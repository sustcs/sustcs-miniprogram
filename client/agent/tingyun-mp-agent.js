"use strict";function d(){return+new Date}var n=[],m={context:null},a={networkType:"",system:wx.getSystemInfoSync()};function t(t){n.push({timestamp:d(),route:t})}function e(){n=[]}function r(){return n.slice()}function i(n){return function(t){return"Array"===n&&Array.isArray?Array.isArray(t):Object.prototype.toString.call(t)==="[object "+n+"]"}}var o=i("String"),c=i("Array"),v=i("Function"),y=i("Object"),u=i("Number");function s(t,n){return function(){if(v(n))try{n.apply(this,arguments)}catch(t){}if(v(t))return t.apply(this,arguments)}}function f(n,e,r){return function(){var t;if(v(e))try{e.apply(this,arguments)}catch(t){}if(v(n)&&(t=n.apply(this,arguments)),v(r))try{r.apply(this,arguments)}catch(t){}return t}}function h(t,n){if(y(t)&&v(t.handler)){var e=t.name,r=t.handler;n[e]=s(n[e],r),n[e]._ty_hook=!0}}function p(){return(getCurrentPages()||[]).map(function(t){return t.route})}function l(){var t=p();return 0<t.length?t[t.length-1]:""}var g=function(){function t(t){return t<0?NaN:t<=30?0|Math.random()*(1<<t):t<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<t-30))*(1<<30):NaN}function n(t,n){for(var e=t.toString(16),r=n-e.length,a="0";0<r;r>>>=1,a+=a)1&r&&(e=a+e);return e}return function(){return n(t(32),8)+"-"+n(t(16),4)+"-"+n(16384|t(12),4)+"-"+n(32768|t(14),4)+"-"+n(t(48),12)}}();function x(t){return t&&o(t)?JSON.parse(t):t}function b(t){try{return x(t)}catch(t){}return null}function q(t){var n="";try{n=JSON.stringify(t)}catch(t){n=""}return n}function T(t){return t+""}function w(t){return t?y(t)?q(t).length:o(t)?t.length:t instanceof ArrayBuffer?t.byteLength:t.length?t.length:0:0}var I="recordTyTime",S="TINGYUN_UID",A="custom",k="TRIGGER_LIFECYCLE",E="2.6.4",O=1e4,_=20,N="event",P="request",C="api",j="timer",R={};function L(t){R=t||{}}var D={},M=[],G=0,U={},Y={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]},H={canSend:!1,sent:!1,apiRemain:0};function F(){D={},M=[],G=0,H.apiRemain=0,Y={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]}}function J(t){if(Y.eventActions||(Y.eventActions=[]),Y.otherActions||(Y.otherActions=[]),t)if(t.type===N){var n=R&&R.eventMaxSize||_;Y.eventActions&&Y.eventActions.length>=n&&Y.eventActions.shift(),Y.eventActions.push(t)}else Y.otherActions.push(t)}function X(){G=d()}var z=6e5,B="TY_SAMPLING",K=wx.getStorageSync(B),V=!1;function Q(t){console.log("TINGYUN AGENT checking sampling"),R.key&&R.beacon&&wx.request({url:"".concat(R.beacon,"/mp-config/config/pullSampling?encodeMpId=").concat(R.key),method:"GET",_no_record:!0,success:function(t){var n=t.data||{},e=n.code,r=n.data;200===e&&r&&(K=r.sampling||1,wx.setStorageSync(B,K))},fail:function(){K=1},complete:function(){t&&t(K)}})}function W(){""===K&&(K=+R.sampleRate||1,Q());var t=Math.random();V=t<=K}setInterval(Q,z);var Z={uid:$(),sid:g(),v:"1.3.2"};function $(){var t=wx.getStorageSync(S);return t||(t=g(),wx.setStorageSync(S,t)),t}function tt(t){if(V){var n=Object.assign({},Z,a||{},{key:R.key},t||{});n.launch=!t,wx.request({url:"".concat(R.beacon,"/mp-app"),data:n,method:"POST",_no_record:!0})}}function nt(t){if(V&&(k===t&&(H.canSend=!0),!H.sent&&H.canSend)){var n=Object.assign({},{path:l(),pageEvent:Object.assign({},D),errs:M.slice(),fromPath:U.prev||"",actions:(Y.eventActions||[]).concat(Y.otherActions||[])},Object.assign({},Z,a||{},{key:R.key}),0<G?{ct:G}:{}),e=r();e&&(n.routeTrack=e),F(),H.sent=!0,H.canSend=!1,wx.request({url:"".concat(R.beacon,"/mp-page"),data:n,method:"POST",_no_record:!0})}}function et(t){W();var n=t.path,e=t.query,r=t.scene;a.openPath=n,a.query=e,a.scene=r,wx.getNetworkType({success:function(t){a.networkType=t.networkType},complete:function(){tt()}})}function rt(t){if(t){var n=t.split(/\n/),e=n[2]||"",c="",u=0,s=0;n.every(function(t){var n=t&&t.trim();if(0===n.indexOf("at ")){var e=n.indexOf("("),r=n.indexOf(")");if(e&&r){var a=e+1;r<a&&(a=r);var i=n.substring(a,r);if(i){var o=i.split(":");o&&2<o.length&&(c=(o.slice(0,o.length-2)||[]).join(":"),u=+o[o.length-2],s=+o[o.length-1])}return!1}}return!0}),c||(c=l()),M.push({time:d(),msg:e,filename:c,lineno:u,colno:s,stack:t})}}function at(){var t=r();e();var n=U.current;U.prev="",U.current="",tt({routeTrack:t,closePath:n})}function it(t,n){t=t.split("."),n=n.split(".");for(var e=Math.max(t.length,n.length);t.length<e;)t.push("0");for(;n.length<e;)n.push("0");for(var r=0;r<e;r++){var a=parseInt(t[r]),i=parseInt(n[r]);if(i<a)return 1;if(a<i)return-1}return 0}function ot(t,n){var e="";return t&&t.system&&(e=t.system.SDKVersion),e&&n?it(e,n):-1}var ct=[{name:"onLaunch",handler:et},{name:"onError",handler:rt},{name:"onHide",handler:at}];function ut(n){return ct.forEach(function(t){h(t,n)}),n}function st(t){return 0<=ot(a,E)?t:ut.apply(this,arguments)}function ft(){var n=App;App=function(t){t=ut(t),n&&n.call(this,t)}}function ht(t){return!R.pages||!c(R.pages)||-1<R.pages.indexOf(t)}function pt(){ht(this.route)&&(D.onLoad=d())}function lt(){ht(this.route)&&(D.onShow=d(),t(this.route),U.prev=U.current,U.current=this.route,H.sent=!1)}function dt(){ht(this.route)&&(D.onReady=d())}function mt(){ht(this.route)&&(D.onHide=d(),nt(k))}function vt(){ht(this.route)&&(D.onUnload=d(),nt(k))}var yt=[{name:"onLoad",handler:pt},{name:"onShow",handler:lt},{name:"onReady",handler:dt},{name:"onHide",handler:mt},{name:"onUnload",handler:vt}];function gt(t,n){for(var e in t)if(t.hasOwnProperty(e)&&v(t[e])&&!t[e]._ty_hook&&v(n)){var r=t[e];t[e]=n.call(this,e,r),t[e]._ty_hook=!0}}var xt=[P,C,j];function bt(){var n={};return xt.forEach(function(t){n[t]={current:0,children:0}}),n}function qt(t,n,e,r,a){this.id=++Y.uniqueId,this.parent=t||null,this.name=n||"<root>",this.type=e||"event",this.subType="event"===this.type?r||"tap":r,this.requests=[],this.apis=[],this.remain=bt(),this.s=d(),this.e=null,this.data=a;var i=this,o=R&&R.eventTimeout||O;this.i=setTimeout(function(){i.timeout()},o),this.closed=!1,this.path=U.current,this.prevPath=U.prev}qt.prototype.end=function(n,t){if(this.closed)console.warn("Current context is already closed");else{if(n)if(n.type===P||n.type===C){var e=n.requests||[],r=n.apis||[];this.requests.map(function(t){"".concat(t.url,"-").concat(t.requestId)===n.name&&(t.requests=e,t.apis=r)}),this.apis.map(function(t){"".concat(t.name,"-").concat(t.apiId)===n.name&&(t.requests=e,t.apis=r)})}else if(n.type===j){var a=n.requests||[],i=n.apis||[];this.requests=[].concat.call(this.requests||[],a),this.apis=[].concat.call(this.apis||[],i)}if(this.isNoRemain()||t)if(console.debug("Context: ",this.name,"will close soon, name:",this.name),this.e=d(),this.closed=!0,this.i&&clearTimeout(this.i),this.parent)this.parent.end(this);else J(this.composeActionData()),m.context=null}},qt.prototype.isNoRemain=function(t){var n=!0;for(var e in this.remain){if(this.remain.hasOwnProperty(e))if(!(this.remain[e].current<=0&&(!!t||this.remain[e].children<=0))){n=!1;break}}return n},qt.prototype.timeout=function(){this.end(null,!0)},qt.prototype.setData=function(t){this.data=t},qt.prototype.composeActionData=function(){var t={id:this.id,name:this.name,type:this.type,start:this.s,end:this.e,duration:0<this.e-this.s?this.e-this.s:0,requests:(this.requests||[]).slice(),apis:(this.apis||[]).slice(),data:this.data||{},path:this.path,prevPath:this.prevPath};return this.type!==P&&this.type!==C||delete(t=Object.assign({},t,this.data)).data,t},qt.prototype.canEnd=function(t,n){return this.isNoRemain(!0)},qt.prototype.isEventChildContext=function(){for(var t=this.parent,n=!1;null!=t;){if("event"===t.type){n=!0;break}t=t.parent}return n},qt.prototype.updateRemain=function(t,n){n||(n=P);var e=t||0;this.remain[n].current=this.remain[n].current+e;for(var r=this.parent;r;)r.remain[n].children=r.remain[n].children+e,r=r.parent},Object.defineProperty(qt.prototype,"current",{get:function(){return m.context},enumerable:!0,configurable:!0}),Object.defineProperty(qt,"createEvent",{value:function(t,n,e,r,a){return new qt(t,n,e||"event",r||null,a)},enumerable:!0,configurable:!0,writable:!0});var Tt="tyname";function wt(t){return!t||"tap"!==t.type||!y(t.target)||!y(t.currentTarget)||null==t.timeStamp}function It(t,n){var e,r=t.target||{},a=r.offsetLeft,i=r.offsetTop,o=r.id,c=r.dataset,u=t.detail||{},s=u.x,f=u.y;t._relatedInfo&&(e=t._relatedInfo.anchorTargetText);var h={target:{offsetLeft:a,offsetTop:i,id:o,x:s,y:f},dataset:{name:c[Tt],targetName:e,methodName:n}},p=n||"";m.context=qt.createEvent(null,p,"event",t.type,h)}function St(){m.context&&m.context.canEnd()&&m.context.end()}function At(r,a){return function(){var t,n=arguments[0]||{},e=wt(n);if(!e)try{It.call(this,n,r)}catch(t){}try{t=a.apply(this,arguments)}finally{if(!e)try{St.call(this)}catch(t){}}return t}}function kt(e){var r=m.context;return function(){var t,n=m.context;m.context=r;try{t=e.apply(this,arguments)}finally{n&&!n.closed&&(m.context=n)}return t}}function Et(t){return kt(t)}function Ot(n){return yt.forEach(function(t){h(t,n)}),gt(n,At),n[I]=X,n}function _t(t){return 0<=ot(a,E)?t:Ot.apply(this,arguments)}function Nt(){var n=Page;Page=function(t){t=Ot(t),n&&n.call(this,t)}}var Pt=wx.request;function Ct(t,n){if(t){var e=b(t["X-Tingyun-Tx-Data"]);if(e&&e.r&&T(e.r)===T(n))return e}return null}function jt(t){if(!t)return 0;var n=t.header,e=t.data,r=0;return(r=+(n&&n["Content-Length"]))&&u(r)&&!Number.isNaN(r)||(r=w(e)||0),r}function Rt(t,n){var e={},r=Ct(t.header,n.r);return r&&(e.s_id=r.id,e.s_name=r.action,r.time&&(e.s_du=r.time.duration,e.s_qu=r.time.qu),e.t_id=r.trId),e}function Lt(t,n,e){return{requestId:t.requestId,type:P,url:t.url,method:t.method,start:t.start,end:t.end,cbTime:t.cbTime,duration:0<t.end-t.start?t.end-t.start:0,send:w(n.data),rec:jt(e),statusCode:e.statusCode||0}}function Dt(t,n){if(!t.context){var e="".concat(t.url,"-").concat(t.requestId);t.context=qt.createEvent(n,e,P)}m.context=t.context}function Mt(t,n,e){m.context&&m.context.setData(e);var r=m.context&&m.context.canEnd();if(r&&m.context.end(),n&&n.id===t.cid&&e){n.requests.push(e);n.remain[P].current;n.updateRemain(-1,P),n.canEnd()&&r&&n.end()}}var Gt=function(){var f=arguments[0]||{};if(!f._no_record&&f.url){var h=m.context,p={requestId:++Y.requestId,url:f.url,method:f.method&&f.method.toUpperCase()||"GET",callbackContextCreated:!1,cbTime:0};p.r=d()%1e9,f.header=f.header||{},f.header["X-Tingyun-Id"]="".concat(R.id,";r=").concat(p.r);var r=f.success,a=f.fail,l=f.complete;f.success=Et(function(){var t;if(p.end||(p.end=d()),Dt(p,h),r){var n=d();try{t=r.apply(this,arguments)}finally{var e=d()-n;0<e&&(p.cbTime+=e)}}return t}),f.fail=Et(function(){var t;if(p.end||(p.end=d()),Dt(p,h),a){var n=d();try{t=a.apply(this,arguments)}finally{var e=d()-n;0<e&&(p.cbTime+=e)}}return t}),f.complete=Et(function(t){var n;if(t.statusCode){var e;p.end||(p.end=d());var r=R[A];if(r&&v(r))try{var a=r.apply(this,arguments);y(a)&&(e={custom:a})}catch(t){}if(Dt(p,h),l){var i=d();try{n=l.apply(this,arguments)}finally{var o=d()-i;0<o&&(p.cbTime+=o)}}var c=Rt(t,p),u=Lt(p,f,t),s=Object.assign({},u,c||{},e||{});return Mt(p,h,s),n}}),p.start=d(),h&&(p.cid=h.id,h.updateRemain(1))}return Pt.apply(this,arguments)};function Ut(){Object.defineProperty(wx,"request",{configurable:!0,enumerable:!0,writable:!0,value:Gt})}function Yt(n){return n.methods||(n.methods={}),yt.forEach(function(t){h(t,n.methods)}),n}function Ht(t){return 0<=ot(a,E)?t:Yt.apply(this,arguments)}function Ft(){var n=Component;Component=function(t){t=Yt(t),n&&n.call(this,t)}}function Jt(t,n){a.uid=t,wx.setStorageSync(S,t)}function Xt(){return m.context}var zt,Bt={version:"1.3.2",setUser:Jt,hookApp:st,hookPage:_t,hookComponent:Ht,request:Gt,getContext:Xt},Kt=["success","fail"],Vt=[],Qt={requestPayment:{fail:function(){var t=arguments&&arguments[0],n="fail";return t&&y(t)&&"requestPayment:fail cancel"===t.errMsg&&(n="cancel"),n}}};function Wt(){(zt=R.hookApis||["requestPayment","scanCode","previewImage"]).forEach(function(t){-1<Vt.indexOf(t)||"request"===t||Vt.push(t)})}function Zt(t){return{apiId:t.apiId,type:C,name:t.name,success:t.success||0,fail:t.fail||0,cancel:t.cancel||0,start:t.start,end:t.end,duration:0<t.end-t.start?t.end-t.start:0,count:1}}function $t(t,n){if(!t.context){var e="".concat(t.name,"-").concat(t.apiId);t.context=qt.createEvent(n,e,C)}m.context=t.context}function tn(t,n,e){m.context&&m.context.setData(e);var r=m.context&&m.context.canEnd();if(r&&m.context.end(),n&&n.id===t.cid&&e){n.apis.push(e);n.remain[C].current;n.updateRemain(-1,C),n.canEnd()&&r&&n.end()}}function nn(a){var n=wx[a];return function(){var e=m.context,t=arguments[0]||{},r={apiId:++Y.apiId,name:a};return Kt.forEach(function(n){t[n]=Et(s(t[n],function(){var t;r.end||(r.end=d()),$t(r,e),(t=Qt[a]&&Qt[a][n]&&v(Qt[a][n])?Qt[a][n].apply(this,arguments):r[n]=1)&&(r[t]=1)}))}),t.complete=Et(f(t.complete,function(){r.end||(r.end=d()),$t(r,e)},function(){var t=Zt(r);tn(r,e,t)})),e&&(r.cid=e.id,e.updateRemain(1,C)),r.start=d(),n.apply(this,arguments)}}function en(t){t&&(wx[t]&&Object.defineProperty(wx,t,{configurable:!0,enumerable:!0,writable:!0,value:nn(t)}))}function rn(){zt||Wt();var n={};return Vt.forEach(function(t){n[t]=nn(t)}),n}function an(){zt||Wt(),Vt.forEach(function(t){en(t)})}wx.onNetworkStatusChange(function(t){a.networkType=t.networkType});var on=!1;function cn(t){(!t||0<=ot(a,E))&&(ft(),Nt(),Ut(),Ft(),an()),t&&Object.assign(Bt,rn()||{})}function un(t){on||(L(t||{}),on=!0,cn(R.plugin))}function sn(){return Bt.config=un,Bt}var fn=sn();module.exports=fn;